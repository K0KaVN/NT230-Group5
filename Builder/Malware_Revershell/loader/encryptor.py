"""
AES-256-GCM Shellcode Encryptor
"""

import os
import sys
from cryptography.hazmat.primitives.ciphers.aead import AESGCM
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2
import base64

default_password = "NT230_Group5_Key"

def generate_key_from_password(password: str, salt: bytes = None) -> tuple:
    """Tạo AES key từ password sử dụng PBKDF2"""
    if salt is None:
        salt = os.urandom(16)
    
    kdf = PBKDF2(
        algorithm=hashes.SHA256(),
        length=32,  # AES-256
        salt=salt,
        iterations=100000,
    )
    key = kdf.derive(password.encode())
    return key, salt

def encrypt_shellcode(shellcode: bytes, password: str) -> dict:
    """
    Mã hóa shellcode bằng AES-256-GCM
    """
    # Tạo key từ password
    key, salt = generate_key_from_password(password)
    
    # Tạo AESGCM instance
    aesgcm = AESGCM(key)
    
    # Tạo nonce (12 bytes cho GCM)
    nonce = os.urandom(12)
    
    # Mã hóa (GCM tự động tạo authentication tag)
    encrypted = aesgcm.encrypt(nonce, shellcode, None)
    
    return {
        'encrypted_data': encrypted,
        'nonce': nonce,
        'salt': salt,
        'key': key  # Để debugging, production nên xóa
    }

def save_encrypted_shellcode(encrypted_dict: dict, output_file: str):
    """
    Lưu shellcode encrypted vào file
    Format: SALT(16) + NONCE(12) + ENCRYPTED_DATA
    """
    with open(output_file, 'wb') as f:
        f.write(encrypted_dict['salt'])      # 16 bytes
        f.write(encrypted_dict['nonce'])     # 12 bytes
        f.write(encrypted_dict['encrypted_data'])  # Variable length

def load_encrypted_shellcode(input_file: str) -> dict:
    with open(input_file, 'rb') as f:
        data = f.read()
    
    return {
        'salt': data[:16],
        'nonce': data[16:28],
        'encrypted_data': data[28:]
    }

def decrypt_shellcode(encrypted_dict: dict, password: str) -> bytes:
    """Giải mã shellcode"""
    key, _ = generate_key_from_password(password, encrypted_dict['salt'])
    
    aesgcm = AESGCM(key)
    shellcode = aesgcm.decrypt(
        encrypted_dict['nonce'],
        encrypted_dict['encrypted_data'],
        None
    )
    
    return shellcode

def print_c_header(encrypted_dict: dict, password: str):
    """In ra C header format để nhúng vào loader"""
    
    key, _ = generate_key_from_password(password, encrypted_dict['salt'])
    
    print(f"unsigned char salt[] = {{ {', '.join(f'0x{b:02x}' for b in encrypted_dict['salt'])} }};")
    print(f"unsigned char nonce[] = {{ {', '.join(f'0x{b:02x}' for b in encrypted_dict['nonce'])} }};")
    print(f"unsigned char aes_key[] = {{ {', '.join(f'0x{b:02x}' for b in key)} }};")
    print(f"size_t encrypted_size = {len(encrypted_dict['encrypted_data'])};")
    print()

def main():
    if len(sys.argv) < 3:
        print("Usage:")
        print("  Encrypt: python encryptor.py <input.bin> <output.bin> [password]")
        print("  Decrypt: python encryptor.py -d <encrypted.bin> <output.bin> [password]")
        print()
        print("Example:")
        print("  python encryptor.py shellcode.bin BT7.docm MySecretPass123")
        print("  python encryptor.py -d BT7.docm decrypted.bin MySecretPass123")
        sys.exit(1)
    
    # Decrypt mode
    if sys.argv[1] == '-d':
        input_file = sys.argv[2]
        output_file = sys.argv[3]
        password = sys.argv[4] if len(sys.argv) > 4 else default_password
        
        print(f"[*] Decrypting {input_file}...")
        encrypted_dict = load_encrypted_shellcode(input_file)
        shellcode = decrypt_shellcode(encrypted_dict, password)
        
        with open(output_file, 'wb') as f:
            f.write(shellcode)
        
        print(f"[+] Decrypted to {output_file}")
        print(f"[+] Size: {len(shellcode)} bytes")
        
    # Encrypt mode
    else:
        input_file = sys.argv[1]
        output_file = sys.argv[2]
        password = sys.argv[3] if len(sys.argv) > 3 else default_password
        
        print(f"[*] Reading shellcode from {input_file}...")
        with open(input_file, 'rb') as f:
            shellcode = f.read()
        
        print(f"[*] Shellcode size: {len(shellcode)} bytes")
        print(f"[*] Encrypting with AES-256-GCM...")
        
        encrypted_dict = encrypt_shellcode(shellcode, password)
        save_encrypted_shellcode(encrypted_dict, output_file)
        
        print(f"[+] Encrypted shellcode saved to: {output_file}")
        print(f"[+] Password: {password}")
        print(f"[+] Total encrypted size: {len(encrypted_dict['encrypted_data'])} bytes")
        
        # In C header
        print_c_header(encrypted_dict, password)
        
        # Verify
        print("\n[*] Verifying encryption...")
        test_dict = load_encrypted_shellcode(output_file)
        test_shellcode = decrypt_shellcode(test_dict, password)
        
        if test_shellcode == shellcode:
            print("[+] Verification successful!")
        else:
            print("[-] Verification failed!")

if __name__ == "__main__":
    main()
